name: Deploy Backend to Railway (via Registry)

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/backend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Railway Redeploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Trigger deployment via Railway API
          # Requires: RAILWAY_TOKEN, RAILWAY_SERVICE_ID, and RAILWAY_ENVIRONMENT_ID in GitHub secrets

          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "RAILWAY_TOKEN not set. Skipping deployment."
            exit 0
          fi

          if [ -z "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
            echo "RAILWAY_SERVICE_ID not set. Skipping deployment."
            exit 0
          fi

          if [ -z "${{ secrets.RAILWAY_ENVIRONMENT_ID }}" ]; then
            echo "RAILWAY_ENVIRONMENT_ID not set. Skipping deployment."
            exit 0
          fi

          echo "Triggering Railway redeploy..."
          RESPONSE=$(curl -s -X POST "https://backboard.railway.app/graphql/v2" \
            -H "Authorization: Bearer $RAILWAY_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"query\": \"mutation serviceInstanceRedeploy(\$serviceId: String!, \$environmentId: String!) { serviceInstanceRedeploy(serviceId: \$serviceId, environmentId: \$environmentId) }\",
              \"variables\": {
                \"serviceId\": \"${{ secrets.RAILWAY_SERVICE_ID }}\",
                \"environmentId\": \"${{ secrets.RAILWAY_ENVIRONMENT_ID }}\"
              }
            }")

          echo "Response: $RESPONSE"

          # Check for errors in response
          if echo "$RESPONSE" | grep -q "errors"; then
            echo "Deployment failed, See response above for details."
            exit 1
          fi

          echo "Deployment triggered successfully!"

      - name: Deployment Summary
        run: |
          echo "Backend deployment process completed"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          