<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skill Issue - Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: #667eea;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 1.1em;
    }

    .status {
      display: inline-block;
      padding: 6px 12px;
      background: #10b981;
      color: white;
      border-radius: 6px;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.5em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .response {
      margin-top: 15px;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }

    .response.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
      display: block;
    }

    .response.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
      display: block;
    }

    .info {
      background: #e0e7ff;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 0.9em;
      color: #4338ca;
    }

    .api-key-info {
      background: #fef3c7;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 0.9em;
      color: #92400e;
    }

    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .stat-card p {
      font-size: 0.9em;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Skill Issue Admin Dashboard</h1>
      <p>Backend API Management Interface</p>
      <span class="status" id="status">Connected</span>
    </div>

    <div class="card full-width">
      <h2>API Configuration</h2>
      <div class="form-group">
        <label for="apiKey">API Key (if required)</label>
        <input type="text" id="apiKey" placeholder="Enter API key if API_AUTH_ENABLED=true">
      </div>
      <div class="api-key-info">
        <strong>Authentication Options:</strong><br>
        • Leave blank if <code>API_AUTH_ENABLED=false</code><br>
        • Enter your API key if authentication is enabled (set via <code>API_KEY</code> env variable)<br>
        • The key will be sent as <code>Authorization: Bearer &lt;key&gt;</code> header
      </div>
    </div>

    <div class="grid">
      <!-- Health Check -->
      <div class="card">
        <h2>Health Check</h2>
        <button onclick="checkHealth()">Check Health</button>
        <div class="response" id="health-response"></div>
      </div>

      <!-- Create User -->
      <div class="card">
        <h2>Create User</h2>
        <div class="form-group">
          <label for="userId">User ID (UUID, optional)</label>
          <input type="text" id="userId" placeholder="Leave blank for auto-generate">
        </div>
        <div class="form-group">
          <label for="deviceId">Device ID (optional)</label>
          <input type="text" id="deviceId" placeholder="e.g., expo-push-token or device identifier">
        </div>
        <div class="form-group">
          <label for="timezone">Timezone</label>
          <input type="text" id="timezone" value="UTC" placeholder="e.g., America/New_York">
        </div>
        <div class="form-group">
          <label for="quietStart">Quiet Hours Start (0-23)</label>
          <input type="number" id="quietStart" min="0" max="23" placeholder="e.g., 22">
        </div>
        <div class="form-group">
          <label for="quietEnd">Quiet Hours End (0-23)</label>
          <input type="number" id="quietEnd" min="0" max="23" placeholder="e.g., 8">
        </div>
        <div class="form-group">
          <label for="maxChallenges">Max Challenges Per Day</label>
          <input type="number" id="maxChallenges" value="5" min="1" max="100">
        </div>
        <button onclick="createUser()">Create User</button>
        <div class="response" id="create-user-response"></div>
      </div>

      <!-- Get Skills -->
      <div class="card">
        <h2>Available Skills</h2>
        <button onclick="getSkills()">Load Skills</button>
        <div class="response" id="skills-response"></div>
      </div>

      <!-- Get User -->
      <div class="card">
        <h2>Get User</h2>
        <div class="form-group">
          <label for="getUserId">User ID</label>
          <input type="text" id="getUserId" placeholder="Enter user UUID">
        </div>
        <button onclick="getUser()">Get User</button>
        <div class="response" id="get-user-response"></div>
      </div>

      <!-- Enroll User in Skill -->
      <div class="card">
        <h2>Enroll User in Skill</h2>
        <div class="form-group">
          <label for="enrollUserId">User ID</label>
          <input type="text" id="enrollUserId" placeholder="Enter user UUID">
        </div>
        <div class="form-group">
          <label for="enrollSkillId">Skill ID</label>
          <input type="text" id="enrollSkillId" placeholder="Enter skill UUID">
        </div>
        <div class="form-group">
          <label for="difficultyTarget">Difficulty Target (1-10)</label>
          <input type="number" id="difficultyTarget" value="2" min="1" max="10">
        </div>
        <button onclick="enrollSkill()">Enroll User</button>
        <div class="response" id="enroll-response"></div>
      </div>

      <!-- Get User Skills -->
      <div class="card">
        <h2>Get User Skills</h2>
        <div class="form-group">
          <label for="userSkillsId">User ID</label>
          <input type="text" id="userSkillsId" placeholder="Enter user UUID">
        </div>
        <button onclick="getUserSkills()">Get User Skills</button>
        <div class="response" id="user-skills-response"></div>
      </div>

      <!-- Manual Scheduler Tick -->
      <div class="card">
        <h2>Manual Scheduler Tick</h2>
        <div class="info">
          Manually trigger the scheduling agent to create challenges for eligible users.
        </div>
        <button onclick="triggerScheduler()">Trigger Scheduler</button>
        <div class="response" id="scheduler-response"></div>
      </div>

      <!-- Get Pending Challenges -->
      <div class="card">
        <h2>Pending Challenges</h2>
        <div class="info">
          View all unanswered challenges for a user. These are challenges that have been created but not yet answered.
        </div>
        <div class="form-group">
          <label for="pendingUserId">User ID</label>
          <input type="text" id="pendingUserId" placeholder="Enter user UUID">
        </div>
        <button onclick="getPendingChallenges()">Get Pending Challenges</button>
        <div class="response" id="pending-response"></div>
      </div>

      <!-- Get Challenge History -->
      <div class="card">
        <h2>Challenge History</h2>
        <div class="form-group">
          <label for="historyUserId">User ID</label>
          <input type="text" id="historyUserId" placeholder="Enter user UUID">
        </div>
        <div class="form-group">
          <label for="historyLimit">Limit</label>
          <input type="number" id="historyLimit" value="10" min="1" max="100">
        </div>
        <button onclick="getChallengeHistory()">Get History</button>
        <div class="response" id="history-response"></div>
      </div>

      <!-- Get Challenge -->
      <div class="card">
        <h2>Get Challenge</h2>
        <div class="info">
          View a specific challenge by ID (without seeing the correct answer).
        </div>
        <div class="form-group">
          <label for="challengeId">Challenge ID</label>
          <input type="text" id="challengeId" placeholder="Enter challenge UUID">
        </div>
        <button onclick="getChallenge()">Get Challenge</button>
        <div class="response" id="challenge-response"></div>
      </div>

      <!-- Answer Challenge -->
      <div class="card">
        <h2>Answer Challenge</h2>
        <div class="form-group">
          <label for="answerChallengeId">Challenge ID</label>
          <input type="text" id="answerChallengeId" placeholder="Enter challenge UUID">
        </div>
        <div class="form-group">
          <label for="answerUserId">User ID</label>
          <input type="text" id="answerUserId" placeholder="Enter user UUID">
        </div>
        <div class="form-group">
          <label for="selectedOption">Selected Option (0-3)</label>
          <input type="number" id="selectedOption" min="0" max="3" placeholder="0, 1, 2, or 3">
        </div>
        <div class="form-group">
          <label for="responseTime">Response Time (ms, optional)</label>
          <input type="number" id="responseTime" placeholder="e.g., 5000">
        </div>
        <div class="form-group">
          <label for="confidence">Confidence (1-5, optional)</label>
          <input type="number" id="confidence" min="1" max="5" placeholder="1-5">
        </div>
        <div class="form-group">
          <label for="userFeedback">Feedback (optional)</label>
          <textarea id="userFeedback" rows="2" placeholder="Optional feedback about the challenge"></textarea>
        </div>
        <button onclick="answerChallenge()">Submit Answer</button>
        <div class="response" id="answer-response"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;

    function getHeaders() {
      const headers = {
        'Content-Type': 'application/json'
      };
      const apiKey = document.getElementById('apiKey').value;
      if (apiKey) {
        headers['Authorization'] = `Bearer ${apiKey}`;
      }
      return headers;
    }

    function showResponse(elementId, data, isError = false) {
      const element = document.getElementById(elementId);
      element.className = 'response ' + (isError ? 'error' : 'success');
      element.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    }

    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE}/api/health`);
        const data = await response.json();
        showResponse('health-response', data);
        document.getElementById('status').textContent = 'Connected';
        document.getElementById('status').style.background = '#10b981';
      } catch (error) {
        showResponse('health-response', { error: error.message }, true);
        document.getElementById('status').textContent = 'Disconnected';
        document.getElementById('status').style.background = '#ef4444';
      }
    }

    async function createUser() {
      const userId = document.getElementById('userId').value || undefined;
      const deviceId = document.getElementById('deviceId').value || undefined;
      const timezone = document.getElementById('timezone').value;
      const quietStart = parseInt(document.getElementById('quietStart').value) || undefined;
      const quietEnd = parseInt(document.getElementById('quietEnd').value) || undefined;
      const maxChallenges = parseInt(document.getElementById('maxChallenges').value);

      try {
        const response = await fetch(`${API_BASE}/api/users`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({
            id: userId,
            deviceId,
            timezone,
            quietHoursStart: quietStart,
            quietHoursEnd: quietEnd,
            maxChallengesPerDay: maxChallenges
          })
        });
        const data = await response.json();
        showResponse('create-user-response', data, !response.ok);
      } catch (error) {
        showResponse('create-user-response', { error: error.message }, true);
      }
    }

    async function getSkills() {
      try {
        const response = await fetch(`${API_BASE}/api/skills`, {
          headers: getHeaders()
        });
        const data = await response.json();
        showResponse('skills-response', data, !response.ok);
      } catch (error) {
        showResponse('skills-response', { error: error.message }, true);
      }
    }

    async function getUser() {
      const userId = document.getElementById('getUserId').value;
      if (!userId) {
        showResponse('get-user-response', { error: 'User ID is required' }, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/users/${userId}`, {
          headers: getHeaders()
        });
        const data = await response.json();
        showResponse('get-user-response', data, !response.ok);
      } catch (error) {
        showResponse('get-user-response', { error: error.message }, true);
      }
    }

    async function enrollSkill() {
      const userId = document.getElementById('enrollUserId').value;
      const skillId = document.getElementById('enrollSkillId').value;
      const difficultyTarget = parseInt(document.getElementById('difficultyTarget').value);

      if (!userId || !skillId) {
        showResponse('enroll-response', { error: 'User ID and Skill ID are required' }, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/users/${userId}/skills`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({
            skillId,
            difficultyTarget
          })
        });
        const data = await response.json();
        showResponse('enroll-response', data, !response.ok);
      } catch (error) {
        showResponse('enroll-response', { error: error.message }, true);
      }
    }

    async function getUserSkills() {
      const userId = document.getElementById('userSkillsId').value;
      if (!userId) {
        showResponse('user-skills-response', { error: 'User ID is required' }, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/users/${userId}/skills`, {
          headers: getHeaders()
        });
        const data = await response.json();
        showResponse('user-skills-response', data, !response.ok);
      } catch (error) {
        showResponse('user-skills-response', { error: error.message }, true);
      }
    }

    async function triggerScheduler() {
      try {
        const response = await fetch(`${API_BASE}/api/scheduler/tick`, {
          method: 'POST',
          headers: getHeaders()
        });
        const data = await response.json();
        showResponse('scheduler-response', data, !response.ok);
      } catch (error) {
        showResponse('scheduler-response', { error: error.message }, true);
      }
    }

    async function getChallengeHistory() {
      const userId = document.getElementById('historyUserId').value;
      const limit = document.getElementById('historyLimit').value;

      if (!userId) {
        showResponse('history-response', { error: 'User ID is required' }, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/users/${userId}/challenges/history?limit=${limit}`, {
          headers: getHeaders()
        });
        const data = await response.json();
        showResponse('history-response', data, !response.ok);
      } catch (error) {
        showResponse('history-response', { error: error.message }, true);
      }
    }

    async function getChallenge() {
      const challengeId = document.getElementById('challengeId').value;

      if (!challengeId) {
        showResponse('challenge-response', { error: 'Challenge ID is required' }, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/challenges/${challengeId}`, {
          headers: getHeaders()
        });
        const data = await response.json();
        showResponse('challenge-response', data, !response.ok);
      } catch (error) {
        showResponse('challenge-response', { error: error.message }, true);
      }
    }

    async function getPendingChallenges() {
      const userId = document.getElementById('pendingUserId').value;

      if (!userId) {
        showResponse('pending-response', { error: 'User ID is required' }, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/users/${userId}/challenges/pending`, {
          headers: getHeaders()
        });
        const data = await response.json();
        showResponse('pending-response', data, !response.ok);
      } catch (error) {
        showResponse('pending-response', { error: error.message }, true);
      }
    }

    async function answerChallenge() {
      const challengeId = document.getElementById('answerChallengeId').value;
      const userId = document.getElementById('answerUserId').value;
      const selectedOption = parseInt(document.getElementById('selectedOption').value);
      const responseTime = parseInt(document.getElementById('responseTime').value) || undefined;
      const confidence = parseInt(document.getElementById('confidence').value) || undefined;
      const userFeedback = document.getElementById('userFeedback').value || undefined;

      if (!challengeId || !userId || isNaN(selectedOption)) {
        showResponse('answer-response', { error: 'Challenge ID, User ID, and Selected Option are required' }, true);
        return;
      }

      if (selectedOption < 0 || selectedOption > 3) {
        showResponse('answer-response', { error: 'Selected Option must be between 0 and 3' }, true);
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/answer`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({
            challengeId,
            userId,
            selectedOption,
            responseTime,
            confidence,
            userFeedback
          })
        });
        const data = await response.json();
        showResponse('answer-response', data, !response.ok);
      } catch (error) {
        showResponse('answer-response', { error: error.message }, true);
      }
    }

    // Check health on page load
    window.onload = () => {
      checkHealth();
    };
  </script>
</body>
</html>
